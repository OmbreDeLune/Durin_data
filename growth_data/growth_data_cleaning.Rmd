---
title: "Growth_data_cleaning"
author: "OmbreDeLune"
date: "2024-06-05"
output: html_document
---
#Loading packages
```{r}
library(usethis)
library(tidyverse)
library(tibble)
library(dplyr)
library(lubridate)
library(zoo)
library(fixr)
```


#Cleaning all data

In order to clean the data, I first import the raw data, a csv document obtain from the original excel document. 
```{r}
raw_data<-read.csv("raw_DURIN_growth_data.csv")
```

First, I want to concatenate the date values in a single value. I create a new column for that.
```{r}
loc <- Sys.getlocale("LC_TIME"); Sys.setlocale("LC_TIME", "en_GB.UTF-8"); Sys.setlocale("LC_TIME", "C")
date_list<-paste(raw_data$year, raw_data$month, raw_data$day, sep = "-")
date_list<-strptime(date_list,format="%Y-%B-%d")
date_list<-as.Date(date_list, format="%Y-%B-%d")
raw_data<-add_column(raw_data, date = date_list, .after = 'year')
```

Now, I verify that every column name is a character.  
```{r}
column_names<-colnames(raw_data)
column_names
str(column_names)
```

Okay, every column name is a character, but some ones are weird. I want to replace them in something more usefull. There is still to change names for the remaining stuff.  


```{r}
names(raw_data)[names(raw_data) == 'photo_comment'] <- 'general_comment'
names(raw_data)[names(raw_data) == 'X..branches.5mm'] <- 'nrb_branches_lger_5mm'
names(raw_data)[names(raw_data) == 'X..broken_branches.5mm'] <- 'nrb_brk_branches_lger_5mm'
names(raw_data)[names(raw_data) == 'X..broken_branches.5mm.1'] <- 'nrb_brk_branches_shtr_5mm'
names(raw_data)[names(raw_data) == 'fruits.or.flowers'] <- 'presence_reproductive_str'
names(raw_data)[names(raw_data) == 'reproductive.stem'] <- 'presence_reproductive_stem'
names(raw_data)[names(raw_data) == 'X._branches_s1'] <- 'nbr_sidebranch_s1'
names(raw_data)[names(raw_data) == 'X._branches_s2'] <- 'nbr_sidebranch_s2'
names(raw_data)[names(raw_data) == 'fruits_s1_y1_b1'] <- 'fruit_count_s1_y1_b1'
names(raw_data)[names(raw_data) == 'fruit_s1_y1_b1'] <- 'fruit_mass_s1_y1_b1'
names(raw_data)[names(raw_data) == 'dead_leaves_s2_y2_b1'] <- 'dead_leaves_mass_s2_y2_b1'

```

I have to add a comment for SO_F_VV_2 as we have a bubble comment about it on the original excel. This comment is on the S2 Y2 B1 dead leaf and says that it is already gone and the remaining peduncle is taken for biomass. As we don't have dead leaf biomass for this sample, we can assume that the dead leaf mentioned is an error, and we suppress it. There should be an alone peduncle in the S2 Y2 B1 leaves though. 
```{r}
raw_data['2',"general_comment"]<-"S2 Y2 B1: 1 lost leaf but with peduncle on the stem, taken for leaves biomass"
raw_data['2','dead_leaf_count_s2_b1']<-0
```


I identify the class of every column. 
```{r}
lapply(raw_data, class)
```

Except for plant_height, every column that should be numerical is numerical. 
We correct the errors. 

The errors and corrections are noticed in the google doc for corrections.
```{r}
grepl('missing', raw_data$plant_height) 
```

```{r}
raw_data$plant_height[raw_data$plant_height=='missing']<-NA
```
We still have to correct the character columns that have numerics somewhere, but I won't do it now. 

```{r}
raw_data$plant_height<-as.numeric(raw_data$plant_height)
class(raw_data$plant_height)
```


I now need to distinct between two samples that were called the same way but with two detached individuals, that were called "individual A" and "individual B" in the raw data. I identify the duplicated rows according to the plotID in order to distinct individuals. 

I suppress every example of duplicated row that has no measure, as it is just an error of where to write the measures. As the length of the longest branch was measured for every sample for that, I suppress rows that were not measured. This include the CV and EN species that we haven't processed, and the rows that were pre-prepared but not used in writing the measures. 

```{r}
raw_data <- raw_data[!is.na(raw_data$length_longest_branch_cm), ]
```
I end up with 76 samples measured, which is coherent as I have 70 different IDs, 4 samples with 2 individuals, and 1 sample with 3 individuals : 
```{r}
raw_data[duplicated(raw_data$DURIN_plot), ]
```


I create a new column, which I will modify manually according to the comment. 

```{r}
com_individual<-rep("A",length(raw_data$length_longest_branch_cm) )
raw_data<-add_column(raw_data, comment_indiv = com_individual, .after = 'DURIN_plot')
```

```{r}
raw_data['35','comment_indiv']<-'B'
raw_data['39','comment_indiv']<-'B'
raw_data['64','comment_indiv']<-'B'
raw_data['79','comment_indiv']<-'B'
raw_data['104','comment_indiv']<-'B'
raw_data['105','comment_indiv']<-'C'
```

Now I remove columns that  are not data but information about processing. 
```{r}
#previously removed, but finally kept : 
#"photoID_N", "photoID_W", "general_comment", "Chopping.technician", "time.spent.on.chopping","weighing.date","Mass.technician","weighing.time", "balance","Chopping.technician.1", "time.spent.on.chopping.1","weighing.date.1", "Mass.technician.1", "weighing.time.1", "Which.balance"
removed_list<-c("ageClass", "DroughtTrt", "DroughNet_plotID",  "REMAINING.BRANCH.PROCESSING......","day","month")
raw_data<-raw_data %>% select(-one_of(removed_list))
```
Maybe I should remove the "Comment_smaller_branches" column too.

Now, I work on other columns that are strange. Their names are ambiguous or redundant, and are the result of misunderstanding between lab workers. As errors, we have sometime written data in those columns  instead of writting them in the right ones. We first correct these errors (see explanations in the google excel), and then suppress them.

First, searching where are the errors.
```{r}
raw_data[raw_data$branch_length_s1_b2 != 0,]
raw_data[raw_data$branch_length_s2_b2 != 0,]
raw_data[raw_data$branch_length_s2_y2_b1.1 != 0,]

```

Manually moving the values in the right place.
!! for SO_F_VM_4 it is not an error, but the sample had this branch. We don't erase the values here. 
```{r}
#wrong branch_length_s1_b2, except "KA_O_VM_3_B"
list_ID<-c("SO_F_VM_1","SO_F_VM_5","LY_O_VM_4","SE_F_VM_1","SE_O_VM_4","KA_O_VM_1")
for (i in list_ID){
  raw_data[raw_data$DURIN_plot == i, c("branch_length_s1_b2", "branch_length_s2_y1_b1")] <- raw_data[raw_data$DURIN_plot == i, c("branch_length_s2_y1_b1", "branch_length_s1_b2")] 
}

#for KA_O_VM_3_B
raw_data[raw_data$DURIN_plot =='KA_O_VM_3' & raw_data$comment_indiv=='B', c("branch_length_s1_b2", "branch_length_s2_y1_b1")] <- raw_data[raw_data$DURIN_plot =='KA_O_VM_3' & raw_data$comment_indiv=='B', c("branch_length_s2_y1_b1", "branch_length_s1_b2")] 



#wrong branch_length_s2_b2
raw_data[raw_data$DURIN_plot =='SE_O_VM_4', c("branch_length_s2_b2", "branch_length_s2_y1_b2")] <- raw_data[raw_data$DURIN_plot =='SE_O_VM_4' , c("branch_length_s2_y1_b2", "branch_length_s2_b2")] 

raw_data[raw_data$DURIN_plot =='KA_O_VM_3' & raw_data$comment_indiv=='B', c("branch_length_s2_b2", "branch_length_s2_y1_b2")] <- raw_data[raw_data$DURIN_plot =='KA_O_VM_3' & raw_data$comment_indiv=='B', c("branch_length_s2_y1_b2", "branch_length_s2_b2")] 


#wrong branch_length_s2_y2_b1.1

raw_data[raw_data$DURIN_plot =='KA_O_VM_3' & raw_data$comment_indiv=='B', c("branch_length_s2_y2_b1.1", "branch_length_s2_y1_b3")] <- raw_data[raw_data$DURIN_plot =='KA_O_VM_3' & raw_data$comment_indiv=='B', c("branch_length_s2_y1_b3", "branch_length_s2_y2_b1.1")] 
```

To verify that it has worked correctly, use this code: 
```{r}
raw_data[c('26','27','28','68','71','72','75','79'),c('DURIN_plot','branch_length_s1_b2','branch_length_s2_b2','branch_length_s2_y2_b1.1','branch_length_s2_y1_b1','branch_length_s2_y1_b2','branch_length_s2_y1_b3')]
```
The data were moved correctly. 



Here, "a" is used to verify that I won't suppress any numeric data.
```{r}
a<-colSums(Filter(is.numeric, raw_data))
a<-a[!is.na(a)]
a<-sum(a)
a
```
a = 164807.7

We can now suppress the strange columns (see explanations)
```{r}
removed_list<-c('alive_leaf_count_s2_b2','dead_leaf_count_s2_b2','alive_leaf_count_s2_y2_b1','dead_leaf_count_s2_y2_b1','leaf_scar_b2_s2','branch_length_s2_y2_b1.1','branch_length_s2_b2')
raw_data<-raw_data %>% select(-one_of(removed_list))
```

We also suppress the flower_mass, fruit_mass and reproductive_part_mass that are totally empty. The data were registered in more specified columns. 
Idem for the dead leaves for S2 Y1 branches that are empty
```{r}
removed_list<-c('flower_mass',"fruit_mass","reproductive_part_mass","dead_leaf_count_s2_y1_b1","dead_leaf_count_s2_y1_b2","dead_leaf_count_s2_y1_b3","dead_leaf_count_s2_y1_b4")
raw_data<-raw_data %>% select(-one_of(removed_list))
```

```{r}
a<-colSums(Filter(is.numeric, raw_data))
a<-a[!is.na(a)]
a<-sum(a)
a
```
a = 164807.7
Right, I haven't suppressed data. 
HAVE A LOOK on tidyvers which do the same and more usefull. 

Let's rename correctly the columns that refers to branch S1 Y1 B2: 
```{r}
names(raw_data)[names(raw_data) == 'alive_leaf_count_s1_b2'] <- 'alive_leaf_count_s1_y1_b2'
names(raw_data)[names(raw_data) == 'dead_leaf_count_s1_b2'] <- 'dead_leaf_count_s1_y1_b2'
names(raw_data)[names(raw_data) == 'branch_length_s1_b2'] <- 'branch_length_s1_y1_b2'
names(raw_data)[names(raw_data) == 'leaf_scar_s1_b2'] <- 'leaf_scar_s1_y1_b2'
```

Same for the columns that register data from S2 Y2 B1 and with an ambiguous name. 
```{r}
names(raw_data)[names(raw_data) == 'alive_leaf_count_s2_b1'] <- 'alive_leaf_count_s2_y2_b1'
names(raw_data)[names(raw_data) == 'dead_leaf_count_s2_b1'] <- 'dead_leaf_count_s2_y2_b1'
```

#Merging columns
In the lab, we have measured everything that should be measured in a plant, adding new columns as we processed samples with new structures. Then, the stems with "reproductive_mass"=NA had no reproductive structures. We can then turn the NAs in 0.

The column "detached_leaf" is useless. It has 1 mass value, a detached_leaf from a VM sample, then it is sure to be part of the S1 Y1 B1 segment. I add it to the leaf_mass_s1_y1_b1 segment. 
```{r}
raw_data$detached_leaf_y1 <- raw_data$detached_leaf_y1 %>% replace(is.na(.), 0)
raw_data$leaf_mass_s1_y1_b1<-raw_data$detached_leaf_y1+raw_data$leaf_mass_s1_y1_b1
raw_data<-raw_data%>% select(-detached_leaf_y1)
```

Idem for the reproductives structures for the different segments. 
```{r}
raw_data$s1_reproductive_part <- raw_data$s1_reproductive_part %>% replace(is.na(.), 0)
raw_data$fruit_mass_s1_y1_b1<-raw_data$s1_reproductive_part+raw_data$fruit_mass_s1_y1_b1
raw_data<-raw_data%>% select(-s1_reproductive_part)
names(raw_data)[names(raw_data) == 'fruit_mass_s1_y1_b1'] <- 'reproductive_mass_s1_y1_b1'
```

Same for s2 y2 b1
```{r}
raw_data$s2_flowers <- raw_data$s2_flowers %>% replace(is.na(.), 0)
raw_data$s2_reproductive_part<-raw_data$s2_reproductive_part+raw_data$s2_flowers
raw_data<-raw_data%>% select(-s2_flowers)
names(raw_data)[names(raw_data) == 's2_reproductive_part'] <- 'reproductive_mass_s2_y2_b1'
```

Same for the only value in S2 Y1 sb1, which concerns a sample with other side branches. I add these values to the other side branches. 
```{r}
#Leaves
raw_data$leaf_s2_y1_sb1 <- raw_data$leaf_s2_y1_sb1 %>% replace(is.na(.), 0)
raw_data$leaf_mass_s2_y1_side_branches<-raw_data$leaf_mass_s2_y1_side_branches+raw_data$leaf_s2_y1_sb1
raw_data<-raw_data%>% select(-leaf_s2_y1_sb1)

#Stem
raw_data$stem_s2_y1_sb1 <- raw_data$stem_s2_y1_sb1 %>% replace(is.na(.), 0)
raw_data$stem_mass_s2_y1_side_branches<-raw_data$stem_mass_s2_y1_side_branches+raw_data$stem_s2_y1_sb1
raw_data<-raw_data%>% select(-stem_s2_y1_sb1)

```


#Total biomass calculation

total reproductive biomass
```{r}
#from main stuff:
raw_data$reproductive_mass_s1_y1_b1 <- raw_data$reproductive_mass_s1_y1_b1 %>% replace(is.na(.), 0)
raw_data$reproductive_mass_s2_y2_b1 <- raw_data$reproductive_mass_s2_y2_b1 %>% replace(is.na(.), 0)
raw_data$fruit_s2_y1_b1 <- raw_data$fruit_s2_y1_b1 %>% replace(is.na(.), 0)
raw_data$total_main_repro_biomass<-raw_data$reproductive_mass_s1_y1_b1+raw_data$reproductive_mass_s2_y2_b1+raw_data$fruit_s2_y1_b1

#from remaining stuff:
raw_data$remainin_.fruit <- raw_data$remainin_.fruit %>% replace(is.na(.), 0)
raw_data$s3_reproductive_structure <- raw_data$s3_reproductive_structure %>% replace(is.na(.), 0)
raw_data$s2_y2_b1_reproductive_structure <- raw_data$s2_y2_b1_reproductive_structure %>% replace(is.na(.), 0)
raw_data$total_remain_repro_biomass<-raw_data$remainin_.fruit+raw_data$s3_reproductive_structure+raw_data$s2_y2_b1_reproductive_structure

#Summing main and remain:
raw_data$total_repro_biomass<-raw_data$total_remain_repro_biomass+raw_data$total_main_repro_biomass
```

for alive vegetative biomass: this includes every leaf and every stem that is alive. 
I consider the broken stem from the remaining stuff not dead stuff. 
```{r}
#for main biomass: 
##NA replacing
raw_data$leaf_mass_s1_y1_b1 <- raw_data$leaf_mass_s1_y1_b1 %>% replace(is.na(.), 0)
raw_data$leaf_mass_s1_y1_b2 <- raw_data$leaf_mass_s1_y1_b2 %>% replace(is.na(.), 0)
raw_data$leaf_mass_s2_y1_side_branches <- raw_data$leaf_mass_s2_y1_side_branches %>% replace(is.na(.), 0)
raw_data$leaf_mass_s2_y2_b1 <- raw_data$leaf_mass_s2_y2_b1 %>% replace(is.na(.), 0)
raw_data$stem_mass_s1_y1_b1 <- raw_data$stem_mass_s1_y1_b1 %>% replace(is.na(.), 0)
raw_data$stem_mass_s1_y1_b2 <- raw_data$stem_mass_s1_y1_b2 %>% replace(is.na(.), 0)
raw_data$stem_mass_s2_y1_side_branches <- raw_data$stem_mass_s2_y1_side_branches %>% replace(is.na(.), 0)
raw_data$stem_mass_s2_y2_b1 <- raw_data$stem_mass_s2_y2_b1 %>% replace(is.na(.), 0)
##sum
raw_data$total_main_vegetative_biomass<-raw_data$leaf_mass_s1_y1_b1+raw_data$leaf_mass_s1_y1_b2+raw_data$leaf_mass_s2_y1_side_branches+raw_data$leaf_mass_s2_y2_b1+raw_data$stem_mass_s1_y1_b1+raw_data$stem_mass_s1_y1_b2+raw_data$stem_mass_s2_y1_side_branches+raw_data$stem_mass_s2_y2_b1

#for remaining biomass:
##NA replacing:
raw_data$leaf_mass_s1_y1_total_remain <- raw_data$leaf_mass_s1_y1_total_remain %>% replace(is.na(.), 0)
raw_data$stem_mass_s1_y1_total_remain <- raw_data$stem_mass_s1_y1_total_remain %>% replace(is.na(.), 0)

raw_data$leaf_mass_s2_y2_total_remain <- raw_data$leaf_mass_s2_y2_total_remain %>% replace(is.na(.), 0)
raw_data$stem_mass_s2_y2_total_remain <- raw_data$stem_mass_s2_y2_total_remain %>% replace(is.na(.), 0)

raw_data$leaf_mass_s2_y1_total_remain <- raw_data$leaf_mass_s2_y1_total_remain %>% replace(is.na(.), 0)
raw_data$stem_mass_s2_y1_total_remain <- raw_data$stem_mass_s2_y1_total_remain %>% replace(is.na(.), 0)

raw_data$leaf_mass_s3_y3_total_remain <- raw_data$leaf_mass_s3_y3_total_remain %>% replace(is.na(.), 0)
raw_data$stem_mass_s3_y3_total_remain <- raw_data$stem_mass_s3_y3_total_remain %>% replace(is.na(.), 0)

raw_data$leaf_mass_s4_y4_total_remain <- raw_data$leaf_mass_s4_y4_total_remain %>% replace(is.na(.), 0)
raw_data$stem_mass_s4_y4_total_remain <- raw_data$stem_mass_s4_y4_total_remain %>% replace(is.na(.), 0)

raw_data$stem_mass_s5_y5_total_remain <- raw_data$stem_mass_s5_y5_total_remain %>% replace(is.na(.), 0)
raw_data$stem_mass_s6_y6_total_remain <- raw_data$stem_mass_s6_y6_total_remain %>% replace(is.na(.), 0)

raw_data$remain_stem_mass <- raw_data$remain_stem_mass %>% replace(is.na(.), 0)
raw_data$broken_stems <- raw_data$broken_stems %>% replace(is.na(.), 0)
raw_data$lost_leaf_mass <- raw_data$lost_leaf_mass %>% replace(is.na(.), 0)

#sum
raw_data$total_remain_vegetative_biomass<-raw_data$leaf_mass_s1_y1_total_remain+raw_data$stem_mass_s1_y1_total_remain+raw_data$leaf_mass_s2_y2_total_remain+raw_data$stem_mass_s2_y2_total_remain+raw_data$leaf_mass_s2_y1_total_remain+raw_data$stem_mass_s2_y1_total_remain+raw_data$leaf_mass_s3_y3_total_remain+raw_data$stem_mass_s3_y3_total_remain+raw_data$leaf_mass_s4_y4_total_remain+raw_data$stem_mass_s4_y4_total_remain+raw_data$stem_mass_s5_y5_total_remain+raw_data$stem_mass_s6_y6_total_remain+raw_data$remain_stem_mass+raw_data$broken_stems+raw_data$lost_leaf_mass

#Summing main and remain:
raw_data$total_vegetative_biomass<-raw_data$total_main_vegetative_biomass+raw_data$total_remain_vegetative_biomass
```

Now summing the total alive biomass: 
```{r}
raw_data$total_alive_biomass<-raw_data$total_repro_biomass+raw_data$total_vegetative_biomass
```


For dead biomass: 
```{r}
#main biomass: already in column dead_leaves_mass_s2_y2_b1

#remain biomass:
raw_data$dead_leaves <- raw_data$dead_leaves %>% replace(is.na(.), 0)
raw_data$dead_stem <- raw_data$dead_stem %>% replace(is.na(.), 0)

raw_data$total_remain_dead_biomass<-raw_data$dead_leaves+raw_data$dead_stem

#total dead biomass:
raw_data$dead_leaves_mass_s2_y2_b1 <- raw_data$dead_leaves_mass_s2_y2_b1 %>% replace(is.na(.), 0)

raw_data$total_dead_biomass<-raw_data$dead_leaves_mass_s2_y2_b1+raw_data$total_remain_dead_biomass
```

```{r}
#total biomass: 
raw_data$total_biomass<-raw_data$total_alive_biomass+raw_data$total_dead_biomass
```



```{r}
half_cleaned_data<-raw_data
```


saving the data frame as a csv document.
```{r}
write.csv(growth_data, "C:\\Users\\ombre\\Desktop\\half_cleaned_data.csv", row.names=FALSE)
```

